<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>resize</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      padding: 0;
    }

    .toolTip {
      width: 100px;
      height: 150px;
      font-size: 1em;
      line-height: 1.5;
      margin: 0;
      list-style: none;
      box-sizing: border-box;
      position: absolute;
      background: #fff;
      color: #333333;
      border-radius: 3px;
      transition: all .1s ease;
      /* pointer-events: none; */
      transform: translate(-50%, 0);
      box-shadow: 0 3px 8px 0 rgba(0, 0, 0, 0.1);
      padding: 10px 10px 8px;
      text-align: center;
      opacity: 1;
      left: 368.88px;
      top: 16.646px;
      display: none;
    }

    .toolTip:after {
      content: '';
      display: block;
      width: 0;
      height: 0;
      position: absolute;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid #fff;
      left: calc(50% - 10px);
      bottom: -9px;
    }
  </style>
</head>

<body style="position:relative">

  <div class="tooltip" id="toolTip" style="opacity: 1; left: 368.88px; top: 16.646px;">
    <form>
      <label for="text">Text:</label><br>
      <input type="text" id="text" name="text" value=""><br>
      <label for="color">Color:</label><br>
      <input type="text" id="color" name="color" value="">
      <input type="submit">
    </form>
  </div>
  <div style="margin-top:300px;" id="bar-parent"></div>

  </div>

  <script>
    class BarMaker {
      constructor(initialState) {
        this.state = {
          segments: [],
          toolTip: {
            form: {
              state: "edit",
              elemenet: null,
              colorInput: null,
              textInput: null,
            },
            element: null
          }
        }
        this.selectedDivider = null
        this.leftWidth = 0
        this.rightWidth = 0
        this.mouseDownHandler = this.mouseDownHandler.bind(this)
        this.mouseMoveHandler = this.mouseMoveHandler.bind(this)
        this.mouseUpHandler = this.mouseUpHandler.bind(this)
        this.onClickHandler = this.onClickHandler.bind(this)
        this.handleFormSubmit = this.handleFormSubmit.bind(this)
        this.initBar(initialState);
      }

      initBar(initialState = {}) {
        if (!initialState.segments || initialState.segements.length === 0) {
          initialState.segments = [
            {
              backgroundColor: "yellow",
              width: (1 / 3) * 100,
              display: "flex",
              height: "100px",
              innerText: "left",
              left: null,
              right: null,
              element: null
            },
            {
              backgroundColor: "pink",
              width: (1 / 3) * 100,
              display: "flex",
              height: "100px",
              innerText: "middle",
              left: null,
              right: null,
              element: null
            },
            {
              backgroundColor: "rgb(109, 220, 240)",
              width: (1 / 3) * 100,
              display: "flex",
              height: "100px",
              innerText: "right",
              left: null,
              right: null,
              element: null
            }
          ]
        }
        if (!initialState.parentID) {
          initialState.parentID = "bar-parent"
        }
        this.state = { ...this.state, ...initialState }

        this.parent = document.querySelector(`#${this.state.parentID}`)
        this.bar = document.createElement('div')
        this.bar.style.display = "flex"
        this.bar.style.height = "100px"
        this.drawBar()
        this.initToolTip()
        this.parent.appendChild(this.bar)
      }

      initToolTip(){
        this.state.toolTip.element = document.querySelector('#toolTip')
        this.bar.appendChild(this.state.toolTip.element)
      }

      drawBar() {
        for (let i = 0; i < this.state.segments.length; i++) {
          const segmentDiv = document.createElement("div")
          const { backgroundColor, width, display, height, innerText } = this.state.segments[i]
          segmentDiv.style.backgroundColor = backgroundColor
          segmentDiv.style.width = `${width}%`
          segmentDiv.style.height = height
          segmentDiv.style.display = display
          segmentDiv.innerText = innerText
          segmentDiv.addEventListener('click', this.onClickHandler)
          this.bar.appendChild(segmentDiv)
          this.state.segments[i].element = segmentDiv

          // If not the last segment, create divider, attach it as segment.right, make 
          // divider.left a reference to segment in state
          if (i !== this.state.segments.length - 1) {
            const dividerDiv = document.createElement('div')
            dividerDiv.style.backgroundColor = "black"
            // dividerDiv.style.height = "100%"
            dividerDiv.style.width = "0"
            dividerDiv.style.position = "relative"
            const dividerChild = document.createElement('div')
            dividerChild.style.position = 'absolute'
            dividerChild.style.left = "-1px"
            dividerChild.style.width = "2px"
            dividerChild.style.backgroundColor = "black"
            dividerChild.style.height = this.bar.style.height
            dividerDiv.appendChild(dividerChild)
            dividerChild.style.cursor = "ew-resize";
            dividerDiv.left = this.state.segments[i]
            this.state.segments[i].right = dividerDiv
            segmentDiv.insertAdjacentElement("afterend", dividerDiv)
            dividerChild.addEventListener("mousedown", this.mouseDownHandler)
          }

          // If not first segment, reference the right divider of last segment,
          // attach is segment.left, and reference current segment as divider.right
          if (i !== 0) {
            const dividerDiv = this.state.segments[i - 1].right
            this.state.segments[i].left = dividerDiv
            dividerDiv.right = this.state.segments[i]
          }
          console.log('this.state.segments[i]', this.state.segments[i])
        }
      }

      onClickHandler(e) {
        e.preventDefault()
        console.log('this.state', this.state)
        // Draw toolTip
        const location = { x: e.clientX, y: this.bar.getBoundingClientRect().top }
        this.state.toolTip.element.style.left = `${location.x}px`
        this.state.toolTip.element.style.top = `-150px`
        this.state.toolTip.element.style.display = "block"
        // Set which segment we clicked on
        this.selectedSeg = this.state.segments.find(s => {
          return s.element === e.target
        })
        // Hydrate form
        this.state.toolTip.form.textInput = document.querySelector('input#text')
        this.state.toolTip.form.textInput.value = this.selectedSeg.innerText
        this.state.toolTip.form.colorInput = document.querySelector('input#color')
        this.state.toolTip.form.colorInput.value = this.selectedSeg.backgroundColor
        this.state.toolTip.form.element = document.querySelector('.toolTip form')
        this.state.toolTip.form.element.addEventListener('submit', this.handleFormSubmit)
      }

      handleFormSubmit(e) {
        e.preventDefault()
        this.selectedSeg.backgroundColor = this.state.toolTip.form.colorInput.value
        this.selectedSeg.innerText = this.state.toolTip.form.textInput.value
        this.clearBar()
        this.drawBar()
        this.state.toolTip.element.style.display = "none"
      }

      clearBar(){
        if(this.state.segments.length !== 0){
          this.state.segments.forEach(seg =>{
            seg.element.remove()
            seg.right && seg.right.remove()
          })
        }
      }

      mouseDownHandler(e) {
        e.preventDefault()
        this.selectedDivider = e.target.parentNode;

        // Get the current mouse position
        this.x = e.clientX;
        console.log('this.selectedDivider', this.selectedDivider)
        this.leftWidth = this.selectedDivider.left.element.getBoundingClientRect().width;
        this.rightWidth = this.selectedDivider.right.element.getBoundingClientRect().width;

        // this.selectedDivider.style.cursor = "col-resize";
        document.body.style.cursor = "ew-resize";

        this.selectedDivider.left.element.style.userSelect = "none";
        // this.selectedDivider.left.element.style.pointerEvents = "none"; // removed onclickhanlder

        this.selectedDivider.right.element.style.userSelect = "none";

        // Attach the listeners to `document`
        document.addEventListener("mousemove", this.mouseMoveHandler);
        document.addEventListener("mouseup", this.mouseUpHandler);
      };

      mouseMoveHandler(e) {
        e.preventDefault()
        // How far the mouse has been moved
        const dx = e.clientX - this.x;
        // console.log('mouse moved', dx)
        const newLeftWidth =
          ((this.leftWidth + dx) * 100) /
          this.parent.getBoundingClientRect().width;
        this.selectedDivider.left.element.style.width = `${newLeftWidth}%`;
        this.selectedDivider.left.width = newLeftWidth

        const newRightWidth =
          ((this.rightWidth - dx) * 100) / // +2 because of width of dividers
          this.parent.getBoundingClientRect().width;
        this.selectedDivider.right.element.style.width = `${newRightWidth}%`;
        this.selectedDivider.right.width = newRightWidth
      }

      mouseUpHandler() {
        document.body.style.removeProperty("cursor");

        // this.selectedDivider.left.element.style.removeProperty("user-select");
        // this.selectedDivider.left.element.style.removeProperty("pointer-events");

        // this.selectedDivider.right.element.style.removeProperty("user-select");
        // this.selectedDivider.right.element.style.removeProperty("pointer-events");

        //old
        //  resizer.style.removeProperty("cursor");
        // document.body.style.removeProperty("cursor");

        // leftSide.style.removeProperty("user-select");
        // leftSide.style.removeProperty("pointer-events");

        // rightSide.style.removeProperty("user-select");
        // rightSide.style.removeProperty("pointer-events");

        // Remove the handlers of `mousemove` and `mouseup`


        this.leftWidth = 0
        this.rightWidth = 0

        this.selectedDivider = null

        document.removeEventListener("mousemove", this.mouseMoveHandler);
        document.removeEventListener("mouseup", this.mouseUpHandler);

        let totalWidthPercent = 0
        let totalWidthPixels = 0
        this.state.segments.forEach(seg => {
          totalWidthPixels += seg.element.getBoundingClientRect().width
          totalWidthPercent += parseFloat(seg.element.style.width)
        })
        console.log({
          totalWidthPercent,
          widthPixelsDiff: this.parent.getBoundingClientRect().width - totalWidthPixels
        })
      };

      createDivider(left = null, right = null) { return { left, right } };

      createSegement(
        left = null,
        right = null,
        color = null,
        width = null
      ) {
        return {
          left, right, color, width
        }
      };
    }
    const bar = new BarMaker()

  </script>
</body>

</html>